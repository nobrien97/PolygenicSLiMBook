<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>8 Running SLiM via a C++ Program | Polygenic SLiMulations: Investigating polygenic adaptation with SLiM 3.</title>
  <meta name="description" content="8 Running SLiM via a C++ Program | Polygenic SLiMulations: Investigating polygenic adaptation with SLiM 3." />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="8 Running SLiM via a C++ Program | Polygenic SLiMulations: Investigating polygenic adaptation with SLiM 3." />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="8 Running SLiM via a C++ Program | Polygenic SLiMulations: Investigating polygenic adaptation with SLiM 3." />
  
  
  

<meta name="author" content="Nick O’Brien" />


<meta name="date" content="2021-06-08" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="running-slim-in-parallel.html"/>
<link rel="next" href="footnotes.html"/>
<script src="libs/header-attrs-2.8/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="styles.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#preface"><i class="fa fa-check"></i><b>1.1</b> Preface</a></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#overview"><i class="fa fa-check"></i><b>1.2</b> Overview</a></li>
<li class="chapter" data-level="1.3" data-path="introduction.html"><a href="introduction.html#prerequisites"><i class="fa fa-check"></i><b>1.3</b> Prerequisites</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="introduction.html"><a href="introduction.html#references"><i class="fa fa-check"></i><b>1.3.1</b> References</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="installing-a-linux-environment-slim-on-the-wsl.html"><a href="installing-a-linux-environment-slim-on-the-wsl.html"><i class="fa fa-check"></i><b>2</b> Installing a Linux environment &amp; SLiM on the WSL</a>
<ul>
<li class="chapter" data-level="2.1" data-path="installing-a-linux-environment-slim-on-the-wsl.html"><a href="installing-a-linux-environment-slim-on-the-wsl.html#overview-1"><i class="fa fa-check"></i><b>2.1</b> Overview</a></li>
<li class="chapter" data-level="2.2" data-path="installing-a-linux-environment-slim-on-the-wsl.html"><a href="installing-a-linux-environment-slim-on-the-wsl.html#why-linux"><i class="fa fa-check"></i><b>2.2</b> Why Linux?</a></li>
<li class="chapter" data-level="2.3" data-path="installing-a-linux-environment-slim-on-the-wsl.html"><a href="installing-a-linux-environment-slim-on-the-wsl.html#the-windows-subsystem-for-linux"><i class="fa fa-check"></i><b>2.3</b> The Windows Subsystem for Linux</a></li>
<li class="chapter" data-level="2.4" data-path="installing-a-linux-environment-slim-on-the-wsl.html"><a href="installing-a-linux-environment-slim-on-the-wsl.html#installing-wsl"><i class="fa fa-check"></i><b>2.4</b> Installing WSL</a></li>
<li class="chapter" data-level="2.5" data-path="installing-a-linux-environment-slim-on-the-wsl.html"><a href="installing-a-linux-environment-slim-on-the-wsl.html#installing-a-desktop-and-setting-up-x11"><i class="fa fa-check"></i><b>2.5</b> Installing a desktop and setting up X11</a></li>
<li class="chapter" data-level="2.6" data-path="installing-a-linux-environment-slim-on-the-wsl.html"><a href="installing-a-linux-environment-slim-on-the-wsl.html#building-slim"><i class="fa fa-check"></i><b>2.6</b> Building SLiM</a></li>
<li class="chapter" data-level="2.7" data-path="installing-a-linux-environment-slim-on-the-wsl.html"><a href="installing-a-linux-environment-slim-on-the-wsl.html#installing-other-useful-apps"><i class="fa fa-check"></i><b>2.7</b> Installing other useful apps</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="terminal-shortcuts-and-basics.html"><a href="terminal-shortcuts-and-basics.html"><i class="fa fa-check"></i><b>3</b> Terminal Shortcuts and Basics</a>
<ul>
<li class="chapter" data-level="3.1" data-path="terminal-shortcuts-and-basics.html"><a href="terminal-shortcuts-and-basics.html#overview-2"><i class="fa fa-check"></i><b>3.1</b> Overview</a></li>
<li class="chapter" data-level="3.2" data-path="terminal-shortcuts-and-basics.html"><a href="terminal-shortcuts-and-basics.html#navigating-folders"><i class="fa fa-check"></i><b>3.2</b> Navigating folders</a></li>
<li class="chapter" data-level="3.3" data-path="terminal-shortcuts-and-basics.html"><a href="terminal-shortcuts-and-basics.html#installing-and-updating-software"><i class="fa fa-check"></i><b>3.3</b> Installing and updating software</a></li>
<li class="chapter" data-level="3.4" data-path="terminal-shortcuts-and-basics.html"><a href="terminal-shortcuts-and-basics.html#input-and-output"><i class="fa fa-check"></i><b>3.4</b> Input and output</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="a-brief-overview-of-polygenic-adaptation.html"><a href="a-brief-overview-of-polygenic-adaptation.html"><i class="fa fa-check"></i><b>4</b> A Brief Overview of Polygenic Adaptation</a>
<ul>
<li class="chapter" data-level="4.1" data-path="a-brief-overview-of-polygenic-adaptation.html"><a href="a-brief-overview-of-polygenic-adaptation.html#overview-3"><i class="fa fa-check"></i><b>4.1</b> Overview</a></li>
<li class="chapter" data-level="4.2" data-path="a-brief-overview-of-polygenic-adaptation.html"><a href="a-brief-overview-of-polygenic-adaptation.html#what-is-polygenic-adaptation"><i class="fa fa-check"></i><b>4.2</b> What is polygenic adaptation?</a></li>
<li class="chapter" data-level="4.3" data-path="a-brief-overview-of-polygenic-adaptation.html"><a href="a-brief-overview-of-polygenic-adaptation.html#fishers-geometrical-model-of-adaptation"><i class="fa fa-check"></i><b>4.3</b> Fisher’s Geometrical model of adaptation</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="references-1.html"><a href="references-1.html"><i class="fa fa-check"></i><b>5</b> References</a></li>
<li class="chapter" data-level="6" data-path="polygenic-adaptation-in-slim.html"><a href="polygenic-adaptation-in-slim.html"><i class="fa fa-check"></i><b>6</b> Polygenic Adaptation in SLiM</a>
<ul>
<li class="chapter" data-level="6.1" data-path="polygenic-adaptation-in-slim.html"><a href="polygenic-adaptation-in-slim.html#overview-4"><i class="fa fa-check"></i><b>6.1</b> Overview</a></li>
<li class="chapter" data-level="6.2" data-path="polygenic-adaptation-in-slim.html"><a href="polygenic-adaptation-in-slim.html#a-single-polygenic-trait-chp5-1_1t.slim"><i class="fa fa-check"></i><b>6.2</b> A Single Polygenic Trait (Chp5-1_1T.slim)</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="running-slim-in-parallel.html"><a href="running-slim-in-parallel.html"><i class="fa fa-check"></i><b>7</b> Running SLiM in Parallel</a>
<ul>
<li class="chapter" data-level="7.1" data-path="running-slim-in-parallel.html"><a href="running-slim-in-parallel.html#overview-5"><i class="fa fa-check"></i><b>7.1</b> Overview</a></li>
<li class="chapter" data-level="7.2" data-path="running-slim-in-parallel.html"><a href="running-slim-in-parallel.html#slim-at-the-command-line"><i class="fa fa-check"></i><b>7.2</b> SLiM at the Command Line</a></li>
<li class="chapter" data-level="7.3" data-path="running-slim-in-parallel.html"><a href="running-slim-in-parallel.html#running-slim-via-bash"><i class="fa fa-check"></i><b>7.3</b> Running SLiM via Bash</a></li>
<li class="chapter" data-level="7.4" data-path="running-slim-in-parallel.html"><a href="running-slim-in-parallel.html#running-slim-via-r"><i class="fa fa-check"></i><b>7.4</b> Running SLiM via R</a></li>
<li class="chapter" data-level="7.5" data-path="running-slim-in-parallel.html"><a href="running-slim-in-parallel.html#running-slim-in-python"><i class="fa fa-check"></i><b>7.5</b> Running SLiM in Python</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="running-slim-via-a-c-program.html"><a href="running-slim-via-a-c-program.html"><i class="fa fa-check"></i><b>8</b> Running SLiM via a C++ Program</a>
<ul>
<li class="chapter" data-level="8.1" data-path="running-slim-via-a-c-program.html"><a href="running-slim-via-a-c-program.html#writing-slim-code-with-parallelism-in-mind"><i class="fa fa-check"></i><b>8.1</b> Writing SLiM code with parallelism in mind</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="running-slim-via-a-c-program.html"><a href="running-slim-via-a-c-program.html#single-file-output"><i class="fa fa-check"></i><b>8.1.1</b> Single file output</a></li>
<li class="chapter" data-level="8.1.2" data-path="running-slim-via-a-c-program.html"><a href="running-slim-via-a-c-program.html#multiple-file-output"><i class="fa fa-check"></i><b>8.1.2</b> Multiple file output</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="footnotes.html"><a href="footnotes.html"><i class="fa fa-check"></i><b>9</b> Footnotes</a></li>
<li class="chapter" data-level="10" data-path="running-slim-on-a-hpc-cluster.html"><a href="running-slim-on-a-hpc-cluster.html"><i class="fa fa-check"></i><b>10</b> Running SLiM on a HPC Cluster</a>
<ul>
<li class="chapter" data-level="10.1" data-path="running-slim-on-a-hpc-cluster.html"><a href="running-slim-on-a-hpc-cluster.html#overview-6"><i class="fa fa-check"></i><b>10.1</b> Overview</a></li>
<li class="chapter" data-level="10.2" data-path="running-slim-on-a-hpc-cluster.html"><a href="running-slim-on-a-hpc-cluster.html#connecting-to-tinaroo-and-set-up"><i class="fa fa-check"></i><b>10.2</b> Connecting to Tinaroo and Set-up</a></li>
<li class="chapter" data-level="10.3" data-path="running-slim-on-a-hpc-cluster.html"><a href="running-slim-on-a-hpc-cluster.html#pbs-scripts"><i class="fa fa-check"></i><b>10.3</b> PBS Scripts</a></li>
<li class="chapter" data-level="10.4" data-path="running-slim-on-a-hpc-cluster.html"><a href="running-slim-on-a-hpc-cluster.html#multi-node-jobs"><i class="fa fa-check"></i><b>10.4</b> Multi-node jobs</a>
<ul>
<li class="chapter" data-level="10.4.1" data-path="running-slim-on-a-hpc-cluster.html"><a href="running-slim-on-a-hpc-cluster.html#job-array-slim-jobs"><i class="fa fa-check"></i><b>10.4.1</b> Job array SLiM jobs</a></li>
<li class="chapter" data-level="10.4.2" data-path="running-slim-on-a-hpc-cluster.html"><a href="running-slim-on-a-hpc-cluster.html#embedded-nimrod-slim-jobs"><i class="fa fa-check"></i><b>10.4.2</b> Embedded Nimrod SLiM jobs</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Polygenic SLiMulations: Investigating polygenic adaptation with SLiM 3.</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="running-slim-via-a-c-program" class="section level1" number="8">
<h1><span class="header-section-number">8</span> Running SLiM via a C++ Program</h1>
<p>Before we go on, I should mention that this part is pretty much always overkill. There really isn’t much of an overhead from running SLiM in
parallel via interpreted languages, so there is little reason to use any C-based language for running SLiM. It’s clunky and kind of a pain.
However, it is an interesting exercise, and in the cases where you need to eke out every iota of performance during a particularly slow
simulation, it might be worthwhile.</p>
<p>This program uses an open source header library to read csv files into vectors. That can be found in the /includes/ folder, and also at the
<a href="https://github.com/ben-strasser/fast-cpp-csv-parser">original GitHub repository</a>. The program uses OpenMP to parallelise a for loop across
multiple cores.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb44-1"><a href="running-slim-via-a-c-program.html#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;includes/csv.h&quot;</span><span class="pp"> </span><span class="co">// https://github.com/awdeorio/csvstream</span></span>
<span id="cb44-2"><a href="running-slim-via-a-c-program.html#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;stdlib.h&quot;</span></span>
<span id="cb44-3"><a href="running-slim-via-a-c-program.html#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="cb44-4"><a href="running-slim-via-a-c-program.html#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;utility&gt;</span></span>
<span id="cb44-5"><a href="running-slim-via-a-c-program.html#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;vector&gt;</span></span>
<span id="cb44-6"><a href="running-slim-via-a-c-program.html#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string&gt;</span></span>
<span id="cb44-7"><a href="running-slim-via-a-c-program.html#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;omp.h&quot;</span></span>
<span id="cb44-8"><a href="running-slim-via-a-c-program.html#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;map&gt;</span></span>
<span id="cb44-9"><a href="running-slim-via-a-c-program.html#cb44-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-10"><a href="running-slim-via-a-c-program.html#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="bu">std::</span>vector; <span class="kw">using</span> <span class="bu">std::</span>string;</span>
<span id="cb44-11"><a href="running-slim-via-a-c-program.html#cb44-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-12"><a href="running-slim-via-a-c-program.html#cb44-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#define THREAD_NUM </span><span class="dv">4</span><span class="pp"> </span><span class="co">//omp_get_thread_num(); // Max CPUs on machine</span></span>
<span id="cb44-13"><a href="running-slim-via-a-c-program.html#cb44-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-14"><a href="running-slim-via-a-c-program.html#cb44-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-15"><a href="running-slim-via-a-c-program.html#cb44-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Escaped &quot; and &#39; are so the command line doesn&#39;t freak out with quotations in the middle of the line for string input</span></span>
<span id="cb44-16"><a href="running-slim-via-a-c-program.html#cb44-16" aria-hidden="true" tabindex="-1"></a><span class="co">// Feed in a single row of the combos.csv and a single seed at a time: the parallelised for loop will do this</span></span>
<span id="cb44-17"><a href="running-slim-via-a-c-program.html#cb44-17" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> runSLiM(<span class="bu">std::</span>pair&lt;<span class="dt">float</span>, string&gt; combo, string seed) {</span>
<span id="cb44-18"><a href="running-slim-via-a-c-program.html#cb44-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> param1 = combo.first;     <span class="co">// Access the pair&#39;s first value, which is param1</span></span>
<span id="cb44-19"><a href="running-slim-via-a-c-program.html#cb44-19" aria-hidden="true" tabindex="-1"></a>    string param2 = combo.second;</span>
<span id="cb44-20"><a href="running-slim-via-a-c-program.html#cb44-20" aria-hidden="true" tabindex="-1"></a>    string callLine = <span class="st">&quot;/path/to/slim -s &quot;</span> + seed + <span class="st">&quot; -d param1=&quot;</span> + <span class="bu">std::</span>to_string(param1) + <span class="st">&quot; -d </span><span class="sc">\&quot;</span><span class="st">param2=</span><span class="sc">\&#39;</span><span class="st">&quot;</span> + param2 + <span class="st">&quot;</span><span class="sc">\&#39;\&quot;</span><span class="st"> ~/Desktop/example_script.slim&quot;</span>;</span>
<span id="cb44-21"><a href="running-slim-via-a-c-program.html#cb44-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>system(callLine.c_str());</span>
<span id="cb44-22"><a href="running-slim-via-a-c-program.html#cb44-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-23"><a href="running-slim-via-a-c-program.html#cb44-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-24"><a href="running-slim-via-a-c-program.html#cb44-24" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main() {</span>
<span id="cb44-25"><a href="running-slim-via-a-c-program.html#cb44-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Read the seeds and combos</span></span>
<span id="cb44-26"><a href="running-slim-via-a-c-program.html#cb44-26" aria-hidden="true" tabindex="-1"></a>    io::CSVReader&lt;<span class="dv">1</span>&gt; seeds(<span class="st">&quot;./seeds.csv&quot;</span>);</span>
<span id="cb44-27"><a href="running-slim-via-a-c-program.html#cb44-27" aria-hidden="true" tabindex="-1"></a>    seeds.read_header(io::ignore_extra_column, <span class="st">&quot;Seed&quot;</span>);</span>
<span id="cb44-28"><a href="running-slim-via-a-c-program.html#cb44-28" aria-hidden="true" tabindex="-1"></a>    vector&lt;string&gt; vSeeds;</span>
<span id="cb44-29"><a href="running-slim-via-a-c-program.html#cb44-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int64_t</span> curSeed;</span>
<span id="cb44-30"><a href="running-slim-via-a-c-program.html#cb44-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// For each row in the file, fill variables with that row&#39;s values</span></span>
<span id="cb44-31"><a href="running-slim-via-a-c-program.html#cb44-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (seeds.read_row(curSeed)) {</span>
<span id="cb44-32"><a href="running-slim-via-a-c-program.html#cb44-32" aria-hidden="true" tabindex="-1"></a>        vSeeds.emplace_back(<span class="bu">std::</span>to_string(curSeed)); <span class="co">// Stick it into a vector of all seeds</span></span>
<span id="cb44-33"><a href="running-slim-via-a-c-program.html#cb44-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb44-34"><a href="running-slim-via-a-c-program.html#cb44-34" aria-hidden="true" tabindex="-1"></a>    io::CSVReader&lt;<span class="dv">2</span>&gt; combos(<span class="st">&quot;./combos.csv&quot;</span>);</span>
<span id="cb44-35"><a href="running-slim-via-a-c-program.html#cb44-35" aria-hidden="true" tabindex="-1"></a>    combos.read_header(io::ignore_extra_column, <span class="st">&quot;param1&quot;</span>, <span class="st">&quot;param2&quot;</span>);</span>
<span id="cb44-36"><a href="running-slim-via-a-c-program.html#cb44-36" aria-hidden="true" tabindex="-1"></a>    vector&lt;<span class="bu">std::</span>pair&lt;<span class="dt">float</span>, string&gt;&gt; vCombos;</span>
<span id="cb44-37"><a href="running-slim-via-a-c-program.html#cb44-37" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> curP1;</span>
<span id="cb44-38"><a href="running-slim-via-a-c-program.html#cb44-38" aria-hidden="true" tabindex="-1"></a>    string curP2;</span>
<span id="cb44-39"><a href="running-slim-via-a-c-program.html#cb44-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (combos.read_row(curP1, curP2)) {</span>
<span id="cb44-40"><a href="running-slim-via-a-c-program.html#cb44-40" aria-hidden="true" tabindex="-1"></a>        vCombos.emplace_back(curP1, curP2); <span class="co">// Same as above, but we are constructing a vector of pairs, where the pair is param1 and param2</span></span>
<span id="cb44-41"><a href="running-slim-via-a-c-program.html#cb44-41" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb44-42"><a href="running-slim-via-a-c-program.html#cb44-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-43"><a href="running-slim-via-a-c-program.html#cb44-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-44"><a href="running-slim-via-a-c-program.html#cb44-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Start of parallel processing code</span></span>
<span id="cb44-45"><a href="running-slim-via-a-c-program.html#cb44-45" aria-hidden="true" tabindex="-1"></a>    omp_set_num_threads(THREAD_NUM); <span class="co">// How many cores to use?</span></span>
<span id="cb44-46"><a href="running-slim-via-a-c-program.html#cb44-46" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#pragma omp parallel for collapse(2) </span><span class="co">// 2 for loops, so collapse those loops into one parallelisable structure</span></span>
<span id="cb44-47"><a href="running-slim-via-a-c-program.html#cb44-47" aria-hidden="true" tabindex="-1"></a>    { </span>
<span id="cb44-48"><a href="running-slim-via-a-c-program.html#cb44-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (<span class="dt">int</span> i=<span class="dv">0</span>; i &lt; vSeeds.size(); ++i) {</span>
<span id="cb44-49"><a href="running-slim-via-a-c-program.html#cb44-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> (<span class="dt">int</span> j=<span class="dv">0</span>; j &lt; vCombos.size(); ++j) {</span>
<span id="cb44-50"><a href="running-slim-via-a-c-program.html#cb44-50" aria-hidden="true" tabindex="-1"></a>                runSLiM(vCombos[j], vSeeds[i]); <span class="co">// run SLiM with a given seed and parameter combination</span></span>
<span id="cb44-51"><a href="running-slim-via-a-c-program.html#cb44-51" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb44-52"><a href="running-slim-via-a-c-program.html#cb44-52" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb44-53"><a href="running-slim-via-a-c-program.html#cb44-53" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb44-54"><a href="running-slim-via-a-c-program.html#cb44-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-55"><a href="running-slim-via-a-c-program.html#cb44-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span>;</span>
<span id="cb44-56"><a href="running-slim-via-a-c-program.html#cb44-56" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Most of this code is just sorting out csv files into structures that we can perform for loops on. We use openMP to parallelise
a nested for loop structure and automatically dish out seed-parameter combinations to the runSLiM() function out to available cores.
This code isn’t particularly nice to look at, nor is it going to work as-is for more than two parameters (<code>std::pair</code> will need
to be another <code>std::vector</code>), however it could be expanded upon to be more customisable (e.g. accepting user input for
filepaths). In addition, it could be part of a larger GUI app to launch parallel SLiM jobs in a more user-friendly way (coming soon?).</p>
<div id="writing-slim-code-with-parallelism-in-mind" class="section level2" number="8.1">
<h2><span class="header-section-number">8.1</span> Writing SLiM code with parallelism in mind</h2>
<p>When it comes to writing your SLiM code, there are a few factors to keep in mind. Perhaps the most important is how you will deal with
output. Will your models all write into the same output file or separate files? Each option has its pros and cons, so I’ll give descriptions
of both.</p>
<div id="single-file-output" class="section level3" number="8.1.1">
<h3><span class="header-section-number">8.1.1</span> Single file output</h3>
<p>If you want to write your output into a single file, you will need to ensure that all <code>writeFile()</code> calls in your script have the
<code>append</code> flag set to <code>T</code>. This way, when writing to the file, SLiM will write a new line character followed by what you are writing
rather than overwriting the file. Be warned that this method isn’t completely safe and can introduce you to race conditions: if two simulations
try to write at the same time, which of the two will write? Will one line of results be lost, will they both be glued together and become a pain
to format, or will everything go as planned? This may or may not be a problem. For example, if you are tracking evolution over long periods of time,
a single missed data point isn’t going to cause you any problems realistically. However, if your data is very detailed and written multiple times
during a generation, then the chances for files to be written at the same time increases. The lesson really is if you write this way, write as little
as you can to minimise the risk of race conditions becoming a problem. I have written output this way through my Honours, and had no issues with overwriting
or missing output. This was with 1152 concurrent simulations, with data being written 200 times per run. However, I have encountered one error since then,
where a single row was appended with no newline character to another, likely due to a similar race condition.</p>
<p>In summary, the chances of problems are low, but never zero<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a>.</p>
</div>
<div id="multiple-file-output" class="section level3" number="8.1.2">
<h3><span class="header-section-number">8.1.2</span> Multiple file output</h3>
<p>If you want to write to multiple files, then you will need to write your output into generated folders or file names based on your seed and parameter
combinations. For this, I recommend defining a ‘model index’ parameter in SLiM, which is unique for each parameter combination. In fact, this parameter
will be useful regardless of your output protocol, as we will see later. This can simply be set asthe row number in your parameter combination table.
For example, in R:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="running-slim-via-a-c-program.html#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Run SLiM</span></span>
<span id="cb45-2"><a href="running-slim-via-a-c-program.html#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">foreach</span>(<span class="at">i=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df.p)) <span class="sc">%:%</span></span>
<span id="cb45-3"><a href="running-slim-via-a-c-program.html#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">foreach</span>(<span class="at">j=</span>seeds<span class="sc">$</span>Seed) <span class="sc">%dopar%</span> {</span>
<span id="cb45-4"><a href="running-slim-via-a-c-program.html#cb45-4" aria-hidden="true" tabindex="-1"></a>        slim_out <span class="ot">&lt;-</span> <span class="fu">system</span>(<span class="fu">sprintf</span>(<span class="st">&quot;/home/$USER/SLiM/slim -s %s -d param1=%f -d modelindex=%i  ~/Desktop/example_script.slim&quot;</span>, <span class="fu">as.character</span>(j), df.p[i,]<span class="sc">$</span>param1, i, <span class="at">intern=</span>T))</span>
<span id="cb45-5"><a href="running-slim-via-a-c-program.html#cb45-5" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<p>Here we set the SLiM constant <code>modelindex</code> equal to <code>i</code>, which is the row number of the parameter combination dataframe in our for loop.</p>
<p>Now to name the output files, we need to combine the seed and modelindex in our SLiM script and specify a filename, like so:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb46-1"><a href="running-slim-via-a-c-program.html#cb46-1" aria-hidden="true" tabindex="-1"></a>initialize() {</span>
<span id="cb46-2"><a href="running-slim-via-a-c-program.html#cb46-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (!exists(<span class="st">&quot;slimgui&quot;</span>)) {</span>
<span id="cb46-3"><a href="running-slim-via-a-c-program.html#cb46-3" aria-hidden="true" tabindex="-1"></a>        setCfgParam(<span class="st">&quot;seed&quot;</span>, getSeed()); <span class="co">// Set the seed as a constant if we&#39;ve run from the command line</span></span>
<span id="cb46-4"><a href="running-slim-via-a-c-program.html#cb46-4" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb46-5"><a href="running-slim-via-a-c-program.html#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> {</span>
<span id="cb46-6"><a href="running-slim-via-a-c-program.html#cb46-6" aria-hidden="true" tabindex="-1"></a>        setSeed(asInteger(round(runif(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>^<span class="dv">62</span> - <span class="dv">1</span>))));</span>
<span id="cb46-7"><a href="running-slim-via-a-c-program.html#cb46-7" aria-hidden="true" tabindex="-1"></a>        setCfgParam(<span class="st">&quot;seed&quot;</span>, getSeed());</span>
<span id="cb46-8"><a href="running-slim-via-a-c-program.html#cb46-8" aria-hidden="true" tabindex="-1"></a>        catn(<span class="st">&quot;Actual seed: &quot;</span> + asInteger(seed)); <span class="co">// Reset the seed to a more controlled value if we&#39;ve run from SLiMgui</span></span>
<span id="cb46-9"><a href="running-slim-via-a-c-program.html#cb46-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb46-10"><a href="running-slim-via-a-c-program.html#cb46-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-11"><a href="running-slim-via-a-c-program.html#cb46-11" aria-hidden="true" tabindex="-1"></a>    setCfgParam(<span class="st">&quot;modelindex&quot;</span>, <span class="dv">1</span>); <span class="co">// Identifier for the combination of predictors used in latin hypercube: this is the row number in the lscombos.csv file</span></span>
<span id="cb46-12"><a href="running-slim-via-a-c-program.html#cb46-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb46-13"><a href="running-slim-via-a-c-program.html#cb46-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb46-14"><a href="running-slim-via-a-c-program.html#cb46-14" aria-hidden="true" tabindex="-1"></a>    setCfgParam(<span class="st">&quot;outputFilepath&quot;</span>, <span class="ch">&#39;.</span><span class="er">/out_</span><span class="ch">&#39;</span> + modelindex + <span class="ch">&#39;_&#39;</span> + seed + <span class="ch">&#39;_</span><span class="er">slim.csv</span><span class="ch">&#39;</span>); <span class="co">// Output filename/path</span></span></code></pre></div>
<p>The output filename of this simulation will be <code>out_&lt;modelindex&gt;_&lt;seed&gt;_slim.csv</code>. Since each simulation is writing to a different file,
there is no chance of the output being overwritten<a href="#fn5" class="footnote-ref" id="fnref5"><sup>5</sup></a>. At the end of your simulations, you can join all these files into one using the
<code>cat</code> bash command:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb47-1"><a href="running-slim-via-a-c-program.html#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> ./* <span class="op">&gt;</span> slim_out.csv</span></code></pre></div>
<p>This will grab all files in the selected folder <code>./</code> and concatenate them together. Note that if newlines aren’t at the bottom
of each file, then this won’t work. However, SLiM should automatically do this, and if not you can use the script:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb48-1"><a href="running-slim-via-a-c-program.html#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">for</span> <span class="fu">file</span> in /path/*.csv</span>
<span id="cb48-2"><a href="running-slim-via-a-c-program.html#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="kw">do</span></span>
<span id="cb48-3"><a href="running-slim-via-a-c-program.html#cb48-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;&quot;</span> <span class="op">&gt;&gt;</span> <span class="st">&quot;</span><span class="va">$file</span><span class="st">&quot;</span></span>
<span id="cb48-4"><a href="running-slim-via-a-c-program.html#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="kw">done</span></span></code></pre></div>
<p>Which will append a newline character to the end of each file<a href="#fn6" class="footnote-ref" id="fnref6"><sup>6</sup></a>.</p>
<p>The main problem with this method is writing to many different files creates overhead that will slow your simulation down, and has the potential
to overload the filesystem. This can cause problems for other users if you are on a HPC. My recommendation is for large simulations you should use
one single large file that you constantly append to, whereas smaller runs are probably fine to do using multiple files.</p>
</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="4">
<li id="fn4"><p>Much like the chances of your cat eating you in your sleep.<a href="running-slim-via-a-c-program.html#fnref4" class="footnote-back">↩︎</a></p></li>
<li id="fn5"><p>There is still a small chance of <code>stdout</code> losing your output if you have a massive amount of I/O that is overloading the filesystem. But just don’t do that.<a href="running-slim-via-a-c-program.html#fnref5" class="footnote-back">↩︎</a></p></li>
<li id="fn6"><p><a href="https://stackoverflow.com/a/31053205/13586824" class="uri">https://stackoverflow.com/a/31053205/13586824</a><a href="running-slim-via-a-c-program.html#fnref6" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="running-slim-in-parallel.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="footnotes.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
